<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Relationship Management</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-size: 13px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif;
    }
    input, select, textarea { font-family: inherit; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Icons
    const Icon = ({ d, size = 24, className = "", strokeWidth = 2 }) => (
      <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth}>{d}</svg>
    );

    const Users = (p) => <Icon {...p} d={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
    const CalendarDays = (p) => <Icon {...p} d={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/></>} />;
    const Calendar = (p) => <Icon {...p} d={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>} />;
    const Clock = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
    const TrendingUp = (p) => <Icon {...p} d={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />;
    const LayoutGrid = (p) => <Icon {...p} d={<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>} />;
    const Plus = (p) => <Icon {...p} d={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />;
    const Edit2 = (p) => <Icon {...p} d={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>} />;
    const Trash2 = (p) => <Icon {...p} d={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />;
    const Check = (p) => <Icon {...p} d={<polyline points="20 6 9 17 4 12"/>} />;
    const X = (p) => <Icon {...p} d={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />;
    const Save = (p) => <Icon {...p} d={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
    const Upload = (p) => <Icon {...p} d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />;
    const Download = (p) => <Icon {...p} d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />;

    const INITIAL_PRODUCTS = [
      'Maintenance Extension', 'Transaction Commitment', 'Income Management', 'Income Reconciliation',
      'Updates (v14 or v15)', 'sCloud Integration', 'Paye.net', 'CS/CS+', 'KlickPay/CSD+', 
      'Paye.net Portal', 'Stored Card', 'P2PE (TMS)', 'eReturns', 'Touch Tone', 'IP', 
      'SCP Portal', 'PPM', 'ITP/CBL', 'Open Banking', 'Smart Gateway', 'Smart Mobile', 
      'eShop', 'Direct Debits', 'PO/PP', 'EPOS', 'Optimize Verify', 'Optimize Fraud', 
      'AP/GP', 'Mobile SDK'
    ];

    const App = () => {
      const [view, setView] = useState('summary');
      const [customers, setCustomers] = useState([]);
      const [prospects, setProspects] = useState([]);
      const [products, setProducts] = useState(INITIAL_PRODUCTS);
      const [filters, setFilters] = useState({ name: '', accountCode: '', manager: '', products: [], status: '' });
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [customerTab, setCustomerTab] = useState('overview');
      const [selectedProspect, setSelectedProspect] = useState(null);
      const [selectedCustomerForEvents, setSelectedCustomerForEvents] = useState(null);
      
      // Forms
      const [onboardStep, setOnboardStep] = useState(1);
      const [onboardData, setOnboardData] = useState({
        accountInfo: { name: '', id: '', industry: '', accountManager: '', active: true, inactiveDate: '' },
        products: {},
        commercial: { arr: '', contractLength: '', renewalDate: '' },
        contacts: [{ name: '', email: '', role: '' }]
      });
      const [editingCustomer, setEditingCustomer] = useState(null);
      
      const [prospectData, setProspectData] = useState({
        name: '', industry: '', salesRep: '', abc: '', margin: '', leadSource: '', stage: 'Lead', productsOfInterest: {}, activities: []
      });
      
      const [eventForm, setEventForm] = useState({ type: 'Account Review', meetingType: 'F2F', date: '', subject: '', notes: '', internalAttendees: '', externalAttendees: '' });
      const [showEventForm, setShowEventForm] = useState(false);
      const [editingEventIdx, setEditingEventIdx] = useState(null);
      
      const [activityForm, setActivityForm] = useState({ type: 'Initial Call', date: '', outcome: '', notes: '' });
      const [showActivityForm, setShowActivityForm] = useState(false);

      const [newProduct, setNewProduct] = useState('');
      const [showProductMgr, setShowProductMgr] = useState(false);

      // Load
      useEffect(() => {
        const stored = localStorage.getItem('crm-data');
        if (stored) {
          const data = JSON.parse(stored);
          setCustomers(data.customers || []);
          setProspects(data.prospects || []);
          setProducts(data.products || INITIAL_PRODUCTS);
        }
      }, []);

      const saveAll = (c, p, pr) => {
        localStorage.setItem('crm-data', JSON.stringify({
          customers: c ?? customers,
          prospects: pr ?? prospects,
          products: p ?? products
        }));
      };

      // Helpers
      const getFiltered = () => {
        return customers.filter(c => {
          const n = !filters.name || c.accountInfo.name.toLowerCase().includes(filters.name.toLowerCase());
          const code = !filters.accountCode || c.accountInfo.id.toLowerCase().includes(filters.accountCode.toLowerCase());
          const mgr = !filters.manager || c.accountInfo.accountManager === filters.manager;
          const prods = filters.products.length === 0 || filters.products.every(p => c.products[p]);
          const active = c.accountInfo.active ?? true;
          const stat = !filters.status || (filters.status === 'active' && active) || (filters.status === 'inactive' && !active);
          return n && code && mgr && prods && stat;
        });
      };

      const uniqueMgrs = [...new Set(customers.map(c => c.accountInfo.accountManager).filter(Boolean))];
      const inputClass = "w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#2A5C59]";

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-8">
          <div className="max-w-[95%] mx-auto">
            <div className="bg-white rounded-lg shadow-xl overflow-hidden border border-gray-200">
              {/* HEADER */}
              <div className="bg-gradient-to-r from-[#2A5C59] via-[#25081F] to-[#E5173F] p-8">
                <div className="flex justify-between items-center">
                  <div>
                    <h1 className="text-3xl font-bold text-white tracking-tight">Customer Relationship Management</h1>
                    <p className="text-gray-100 mt-2 text-sm">Enterprise Portfolio & Event Management</p>
                  </div>
                  <div className="flex gap-3">
                    {[
                      ['summary', 'Summary', Users],
                      ['portfolio', 'Portfolio', LayoutGrid],
                      ['prospects', 'Prospects', TrendingUp],
                      ['renewals', 'Renewals', Calendar],
                      ['events', 'Meetings', CalendarDays],
                      ['timeline', 'Timeline', Clock]
                    ].map(([v, label, IconComp]) => (
                      <button key={v} onClick={() => setView(v)} className={`px-5 py-2.5 rounded-lg font-semibold transition-all flex items-center text-sm uppercase tracking-wide ${view === v ? 'bg-white text-gray-800 shadow-lg' : 'bg-white/20 text-white hover:bg-white/30'}`}>
                        <IconComp size={16} className="inline mr-2" />{label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* CONTENT */}
              <div className="p-6">
                {/* CUSTOMER SUMMARY - LANDING PAGE */}
                {view === 'summary' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-2xl font-bold text-gray-800">Customer Summary</h2>
                        <p className="text-gray-600 mt-1 text-xs uppercase tracking-wide">{customers.length} Total Customers</p>
                      </div>
                      <button onClick={() => {
                        setOnboardData({ accountInfo: { name: '', id: '', industry: '', accountManager: '', active: true, inactiveDate: '' }, products: {}, commercial: { arr: '', contractLength: '', renewalDate: '' }, contacts: [{ name: '', email: '', role: '' }] });
                        setEditingCustomer(null);
                        setOnboardStep(1);
                        setView('onboard');
                      }} className="px-4 py-2 bg-[#E5173F] text-white rounded-lg hover:bg-[#c4132f] text-sm font-semibold uppercase shadow-md">
                        <Plus size={16} className="inline mr-2" />New Customer
                      </button>
                    </div>

                    <div className="grid grid-cols-4 gap-4">
                      {customers.map(c => {
                        const prodCount = Object.values(c.products).filter(Boolean).length;
                        const eventCount = (c.events || []).length;
                        const isActive = c.accountInfo.active ?? true;
                        
                        return (
                          <div key={c.id} onClick={() => { setSelectedCustomer(c); setCustomerTab('overview'); setView('customer'); }} className="bg-white rounded-xl shadow-md border-2 border-gray-200 p-5 cursor-pointer hover:border-[#2A5C59] hover:shadow-lg hover:-translate-y-1 transition-all">
                            <div className="flex items-center gap-3 mb-3">
                              <div className="w-12 h-12 min-w-[48px] min-h-[48px] bg-gradient-to-br from-[#2A5C59] to-[#E5173F] rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md flex-shrink-0">
                                {c.accountInfo.name.charAt(0)}
                              </div>
                              <div className="flex-1 min-w-0">
                                <p className="font-bold text-sm text-gray-800 truncate">{c.accountInfo.name}</p>
                                <p className="text-xs text-gray-500 font-mono">{c.accountInfo.id}</p>
                              </div>
                            </div>
                            
                            <div className="space-y-2 mb-3">
                              <div className="flex justify-between text-xs">
                                <span className="text-gray-600 font-semibold uppercase">ARR:</span>
                                <span className="font-bold text-green-700 text-base">¬£{Math.round(parseFloat(c.commercial.arr) || 0).toLocaleString()}</span>
                              </div>
                              <div className="flex justify-between text-xs">
                                <span className="text-gray-600 font-semibold uppercase">Manager:</span>
                                <span className="font-semibold text-gray-800 truncate ml-2">{c.accountInfo.accountManager}</span>
                              </div>
                              <div className="flex justify-between text-xs">
                                <span className="text-gray-600 font-semibold uppercase">Products:</span>
                                <span className="font-semibold">{prodCount}</span>
                              </div>
                              <div className="flex justify-between text-xs">
                                <span className="text-gray-600 font-semibold uppercase">Meetings:</span>
                                <span className="font-semibold">{eventCount}</span>
                              </div>
                            </div>

                            <div className="flex items-center justify-between pt-3 border-t border-gray-200">
                              {isActive ? (
                                <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-md text-xs font-bold">
                                  <span className="w-2 h-2 rounded-full bg-green-500"></span>Active
                                </span>
                              ) : (
                                <span className="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-800 rounded-md text-xs font-bold">
                                  <span className="w-2 h-2 rounded-full bg-red-500"></span>Inactive
                                </span>
                              )}
                              <div className="flex gap-1">
                                <button onClick={(e) => { e.stopPropagation(); setSelectedCustomerForEvents(c); setView('events'); }} className="p-1.5 text-[#E5173F] hover:bg-red-50 rounded">
                                  <CalendarDays size={14} />
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); setEditingCustomer(c); setOnboardData(c); setOnboardStep(1); setView('onboard'); }} className="p-1.5 text-[#2A5C59] hover:bg-teal-50 rounded">
                                  <Edit2 size={14} />
                                </button>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* CUSTOMER PORTFOLIO TABLE */}
                {view === 'portfolio' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-2xl font-bold text-gray-800">Customer Portfolio</h2>
                        <p className="text-gray-600 mt-1 text-xs uppercase tracking-wide">{getFiltered().length} of {customers.length} Accounts</p>
                      </div>
                      <div className="flex gap-3">
                        <label className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 cursor-pointer text-sm font-semibold uppercase shadow-md flex items-center">
                          <Upload size={16} className="inline mr-2" />Import
                          <input type="file" accept=".csv" onChange={(e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = (event) => {
                              const lines = event.target.result.split('\n');
                              const headers = lines[0].split(',');
                              const imported = lines.slice(1).filter(l => l.trim()).map(line => {
                                const vals = line.split(',');
                                const prods = {};
                                products.forEach((p, i) => {
                                  const idx = headers.indexOf(p);
                                  if (idx >= 0) prods[p] = vals[idx]?.toLowerCase() === 'yes';
                                });
                                return {
                                  id: Date.now().toString() + Math.random(),
                                  accountInfo: { name: vals[0] || '', id: vals[1] || '', industry: vals[2] || '', accountManager: vals[3] || '', active: true, inactiveDate: '' },
                                  commercial: { arr: vals[4] || '', contractLength: vals[5] || '', renewalDate: vals[6] || '' },
                                  products: prods,
                                  contacts: [{ name: '', email: '', role: '' }],
                                  events: [],
                                  createdAt: new Date().toISOString()
                                };
                              });
                              const updated = [...customers, ...imported];
                              setCustomers(updated);
                              saveAll(updated, products, prospects);
                            };
                            reader.readAsText(file);
                          }} className="hidden" />
                        </label>
                        <button onClick={() => {
                          const csv = [
                            ['Customer Name', 'ID', 'Industry', 'Account Manager', 'ARR', 'Contract Length', 'Renewal Date', ...products],
                            ...customers.map(c => [c.accountInfo.name, c.accountInfo.id, c.accountInfo.industry, c.accountInfo.accountManager, c.commercial.arr, c.commercial.contractLength, c.commercial.renewalDate, ...products.map(p => c.products[p] ? 'Yes' : 'No')])
                          ].map(row => row.join(',')).join('\n');
                          const blob = new Blob([csv], { type: 'text/csv' });
                          const url = URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = 'customers.csv';
                          a.click();
                        }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold uppercase shadow-md flex items-center">
                          <Download size={16} className="inline mr-2" />Export
                        </button>
                        <button onClick={() => {
                          setOnboardData({ accountInfo: { name: '', id: '', industry: '', accountManager: '', active: true, inactiveDate: '' }, products: {}, commercial: { arr: '', contractLength: '', renewalDate: '' }, contacts: [{ name: '', email: '', role: '' }] });
                          setEditingCustomer(null);
                          setOnboardStep(1);
                          setView('onboard');
                        }} className="px-4 py-2 bg-[#E5173F] text-white rounded-lg hover:bg-[#c4132f] text-sm font-semibold uppercase shadow-md flex items-center">
                          <Plus size={16} className="inline mr-2" />New Customer
                        </button>
                      </div>
                    </div>

                    {/* Filters */}
                    <div className="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                      <h3 className="font-bold text-sm uppercase tracking-wide text-gray-700 mb-4">Filters</h3>
                      <div className="grid grid-cols-5 gap-4">
                        <div>
                          <label className="block text-xs font-bold text-gray-700 mb-1 uppercase">Name</label>
                          <input type="text" placeholder="Search..." value={filters.name} onChange={e => setFilters({...filters, name: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]" />
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-gray-700 mb-1 uppercase">Code</label>
                          <input type="text" placeholder="Search..." value={filters.accountCode} onChange={e => setFilters({...filters, accountCode: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]" />
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-gray-700 mb-1 uppercase">Manager</label>
                          <select value={filters.manager} onChange={e => setFilters({...filters, manager: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]">
                            <option value="">All</option>
                            {uniqueMgrs.map(m => <option key={m} value={m}>{m}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-gray-700 mb-1 uppercase">Products</label>
                          <select multiple value={filters.products} onChange={e => setFilters({...filters, products: Array.from(e.target.selectedOptions, o => o.value)})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" style={{height: '80px'}}>
                            {products.map(p => <option key={p} value={p}>{p}</option>)}
                          </select>
                          <p className="text-[10px] text-gray-500 mt-1">Ctrl+click for multiple</p>
                          {filters.products.length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-2">
                              {filters.products.map(p => (
                                <span key={p} className="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold flex items-center gap-1">
                                  {p}<button onClick={() => setFilters({...filters, products: filters.products.filter(x => x !== p)})} className="hover:text-purple-900"><X size={12} /></button>
                                </span>
                              ))}
                            </div>
                          )}
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-gray-700 mb-1 uppercase">Status</label>
                          <select value={filters.status} onChange={e => setFilters({...filters, status: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                          </select>
                        </div>
                      </div>
                      {(filters.name || filters.accountCode || filters.manager || filters.products.length || filters.status) && (
                        <button onClick={() => setFilters({ name: '', accountCode: '', manager: '', products: [], status: '' })} className="mt-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-xs font-semibold uppercase">Clear</button>
                      )}
                    </div>

                    {/* Table */}
                    <div className="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                      <div className="overflow-x-auto" style={{maxHeight: '75vh'}}>
                        <table className="w-full">
                          <thead className="bg-gradient-to-r from-gray-100 to-gray-50 sticky top-0 border-b-2 border-gray-300 z-20">
                            <tr>
                              <th className="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase sticky left-0 bg-gradient-to-r from-gray-100 to-gray-50 z-30 border-r border-gray-200">Customer</th>
                              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase">ID</th>
                              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase">Industry</th>
                              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase">Manager</th>
                              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase">ARR</th>
                              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase">Status</th>
                              {products.map(p => (
                                <th key={p} className="px-2 py-4 text-[11px] font-medium text-gray-600 uppercase border-l border-gray-200" style={{minWidth: '90px', writingMode: 'vertical-rl', transform: 'rotate(180deg)'}}>{p}</th>
                              ))}
                              <th className="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase sticky right-0 bg-gradient-to-r from-gray-100 to-gray-50 z-30 border-l-2 border-gray-300">Actions</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {getFiltered().map((c, idx) => (
                              <tr key={c.id} className={`hover:bg-blue-50 transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                <td onClick={() => { setSelectedCustomer(c); setCustomerTab('overview'); setView('customer'); }} className="px-6 py-4 font-semibold text-gray-800 sticky left-0 bg-inherit z-10 border-r border-gray-200 cursor-pointer">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 min-w-[40px] min-h-[40px] bg-gradient-to-br from-[#2A5C59] to-[#E5173F] rounded-lg flex items-center justify-center text-white font-bold shadow-sm flex-shrink-0">
                                      {c.accountInfo.name.charAt(0)}
                                    </div>
                                    <span className="font-medium hover:text-[#2A5C59]">{c.accountInfo.name}</span>
                                  </div>
                                </td>
                                <td className="px-4 py-4 text-sm text-gray-700 font-mono">{c.accountInfo.id}</td>
                                <td className="px-4 py-4 text-sm text-gray-700">{c.accountInfo.industry}</td>
                                <td className="px-4 py-4 text-sm text-gray-700">{c.accountInfo.accountManager}</td>
                                <td className="px-4 py-4 text-sm font-bold text-green-700">¬£{Math.round(parseFloat(c.commercial.arr) || 0).toLocaleString()}</td>
                                <td className="px-4 py-4">
                                  {(c.accountInfo.active ?? true) ? (
                                    <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-md text-xs font-bold">
                                      <span className="w-2 h-2 rounded-full bg-green-500"></span>Active
                                    </span>
                                  ) : (
                                    <span className="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-800 rounded-md text-xs font-bold">
                                      <span className="w-2 h-2 rounded-full bg-red-500"></span>Inactive
                                    </span>
                                  )}
                                </td>
                                {products.map(p => (
                                  <td key={p} className="px-2 py-4 text-center border-l border-gray-200">
                                    {c.products[p] ? (
                                      <div className="inline-flex items-center justify-center w-7 h-7 bg-green-100 rounded-md border border-green-300">
                                        <Check size={14} className="text-green-700" strokeWidth={3} />
                                      </div>
                                    ) : (
                                      <div className="inline-flex items-center justify-center w-7 h-7 bg-gray-100 rounded-md border border-gray-300">
                                        <X size={14} className="text-gray-400" />
                                      </div>
                                    )}
                                  </td>
                                ))}
                                <td className="px-6 py-4 sticky right-0 bg-inherit z-10 border-l-2 border-gray-300">
                                  <div className="flex gap-2 justify-center">
                                    <button onClick={() => { setSelectedCustomerForEvents(c); setView('events'); }} className="p-2 text-[#E5173F] hover:bg-red-50 rounded-lg" title="Meetings">
                                      <CalendarDays size={18} />
                                    </button>
                                    <button onClick={() => { setEditingCustomer(c); setOnboardData(c); setOnboardStep(1); setView('onboard'); }} className="p-2 text-[#2A5C59] hover:bg-teal-50 rounded-lg">
                                      <Edit2 size={18} />
                                    </button>
                                    <button onClick={() => {
                                      if (confirm('Delete this customer?')) {
                                        const updated = customers.filter(x => x.id !== c.id);
                                        setCustomers(updated);
                                        saveAll(updated, products, prospects);
                                      }
                                    }} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                      <Trash2 size={18} />
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {/* Continuing with more pages... */}

                {/* CUSTOMER DETAIL WITH TABS */}
                {view === 'customer' && selectedCustomer && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-3xl font-bold text-gray-800">{selectedCustomer.accountInfo.name}</h2>
                        <p className="text-gray-600 mt-1 text-xs uppercase tracking-wide">ID: {selectedCustomer.accountInfo.id}</p>
                      </div>
                      <button onClick={() => { setSelectedCustomer(null); setView('summary'); }} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-semibold uppercase">Back</button>
                    </div>

                    {/* TABS */}
                    <div className="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                      <div className="flex border-b border-gray-200">
                        {[['overview', 'Overview'], ['plan', 'Account Plan'], ['meetings', 'Meetings'], ['products', 'Products']].map(([tab, label]) => (
                          <button key={tab} onClick={() => setCustomerTab(tab)} className={`px-6 py-3 text-sm font-semibold uppercase tracking-wide transition-all ${customerTab === tab ? 'bg-[#2A5C59] text-white' : 'text-gray-600 hover:bg-gray-50'}`}>
                            {label}
                          </button>
                        ))}
                      </div>

                      <div className="p-6">
                        {/* OVERVIEW TAB */}
                        {customerTab === 'overview' && (
                          <div className="grid grid-cols-3 gap-6">
                            <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">
                              <h3 className="font-bold text-base mb-4 uppercase tracking-wide text-gray-700 border-b-2 border-gray-300 pb-2">Account Info</h3>
                              <div className="space-y-3 text-sm">
                                <div className="flex justify-between py-2 border-b border-gray-200"><span className="text-gray-600 font-semibold uppercase">Name:</span><span className="font-bold">{selectedCustomer.accountInfo.name}</span></div>
                                <div className="flex justify-between py-2 border-b border-gray-200"><span className="text-gray-600 font-semibold uppercase">ID:</span><span className="font-mono font-bold">{selectedCustomer.accountInfo.id}</span></div>
                                <div className="flex justify-between py-2 border-b border-gray-200"><span className="text-gray-600 font-semibold uppercase">Industry:</span><span className="font-semibold">{selectedCustomer.accountInfo.industry}</span></div>
                                <div className="flex justify-between py-2"><span className="text-gray-600 font-semibold uppercase">Manager:</span><span className="font-semibold">{selectedCustomer.accountInfo.accountManager}</span></div>
                              </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">
                              <h3 className="font-bold text-base mb-4 uppercase tracking-wide text-gray-700 border-b-2 border-gray-300 pb-2">Commercial</h3>
                              <div className="space-y-3 text-sm">
                                <div className="flex justify-between py-2 border-b border-gray-200"><span className="text-gray-600 font-semibold uppercase">ARR:</span><span className="font-bold text-green-700 text-lg">¬£{Math.round(parseFloat(selectedCustomer.commercial.arr) || 0).toLocaleString()}</span></div>
                                <div className="flex justify-between py-2 border-b border-gray-200"><span className="text-gray-600 font-semibold uppercase">Contract:</span><span className="font-semibold">{selectedCustomer.commercial.contractLength} Year(s)</span></div>
                                <div className="flex justify-between py-2"><span className="text-gray-600 font-semibold uppercase">Renewal:</span><span className="font-semibold">{selectedCustomer.commercial.renewalDate}</span></div>
                              </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">
                              <h3 className="font-bold text-base mb-4 uppercase tracking-wide text-gray-700 border-b-2 border-gray-300 pb-2">Quick Actions</h3>
                              <div className="space-y-3">
                                <button onClick={() => setCustomerTab('plan')} className="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-semibold uppercase shadow-md">üìã Account Plan</button>
                                <button onClick={() => { setSelectedCustomerForEvents(selectedCustomer); setView('events'); }} className="w-full px-4 py-3 bg-[#E5173F] text-white rounded-lg hover:bg-[#c4132f] text-sm font-semibold uppercase shadow-md">
                                  <CalendarDays size={18} className="inline mr-2" />Meetings
                                </button>
                                <button onClick={() => { setEditingCustomer(selectedCustomer); setOnboardData(selectedCustomer); setOnboardStep(1); setView('onboard'); }} className="w-full px-4 py-3 bg-[#2A5C59] text-white rounded-lg hover:bg-[#1f4745] text-sm font-semibold uppercase shadow-md">
                                  <Edit2 size={18} className="inline mr-2" />Edit
                                </button>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* ACCOUNT PLAN TAB - COMPLETE */}
                        {customerTab === 'plan' && (
                          <div className="space-y-6">
                            <div className="grid grid-cols-4 gap-6">
                              <div className="col-span-3 space-y-6">
                                {/* Customer History */}
                                <details open className="bg-white rounded-lg shadow-md border-2 border-gray-200">
                                  <summary className="p-4 cursor-pointer font-bold text-base uppercase tracking-wide text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-300 hover:bg-gray-100">üìù Customer History</summary>
                                  <div className="p-6 space-y-4">
                                    <div>
                                      <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Past Conversations</label>
                                      <textarea
                                        value={selectedCustomer.accountPlan?.pastConversations || ''}
                                        onChange={e => {
                                          const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), pastConversations: e.target.value}} : c);
                                          setCustomers(updated);
                                          setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                          saveAll(updated, products, prospects);
                                        }}
                                        placeholder="Historical context, when became customer, key milestones..."
                                        rows={6}
                                        className="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]"
                                      />
                                    </div>
                                    <div>
                                      <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Today / Current Status</label>
                                      <textarea
                                        value={selectedCustomer.accountPlan?.currentStatus || ''}
                                        onChange={e => {
                                          const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), currentStatus: e.target.value}} : c);
                                          setCustomers(updated);
                                          setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                          saveAll(updated, products, prospects);
                                        }}
                                        placeholder="Current issues, recent meetings, action items, ongoing discussions..."
                                        rows={8}
                                        className="w-full px-4 py-3 bg-blue-50 border border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                      />
                                    </div>
                                  </div>
                                </details>

                                {/* Key Stakeholders */}
                                <details open className="bg-white rounded-lg shadow-md border-2 border-gray-200">
                                  <summary className="p-4 cursor-pointer font-bold text-base uppercase tracking-wide text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-300 hover:bg-gray-100">üë• Key Stakeholders</summary>
                                  <div className="p-6">
                                    <div className="mb-4 flex justify-between">
                                      <p className="text-xs text-gray-600">Onboarding contacts auto-included</p>
                                      <button onClick={() => {
                                        const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), stakeholders: [...(c.accountPlan?.stakeholders || []), {id: Date.now().toString(), name: '', email: '', role: ''}]}} : c);
                                        setCustomers(updated);
                                        setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                        saveAll(updated, products, prospects);
                                      }} className="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs font-semibold uppercase">
                                        <Plus size={14} className="inline mr-1" />Add
                                      </button>
                                    </div>
                                    <table className="w-full text-sm">
                                      <thead className="bg-gray-50 border-b-2 border-gray-300">
                                        <tr>
                                          <th className="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Name</th>
                                          <th className="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Email</th>
                                          <th className="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Role</th>
                                          <th className="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Source</th>
                                          <th className="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase w-16">Del</th>
                                        </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-200">
                                        {selectedCustomer.contacts.map((c, i) => (
                                          <tr key={i} className="bg-blue-50">
                                            <td className="px-3 py-2 font-semibold">{c.name}</td>
                                            <td className="px-3 py-2">{c.email}</td>
                                            <td className="px-3 py-2">{c.role}</td>
                                            <td className="px-3 py-2"><span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">Onboarding</span></td>
                                            <td className="px-3 py-2 text-center text-xs text-gray-500">‚Äî</td>
                                          </tr>
                                        ))}
                                        {(selectedCustomer.accountPlan?.stakeholders || []).map((s, i) => (
                                          <tr key={s.id}>
                                            <td className="px-3 py-2"><input value={s.name} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newS = [...(c.accountPlan?.stakeholders || [])];
                                                  newS[i].name = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), stakeholders: newS}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} placeholder="Name" className="w-full px-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs" /></td>
                                            <td className="px-3 py-2"><input value={s.email} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newS = [...(c.accountPlan?.stakeholders || [])];
                                                  newS[i].email = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), stakeholders: newS}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} placeholder="Email" className="w-full px-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs" /></td>
                                            <td className="px-3 py-2"><input value={s.role} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newS = [...(c.accountPlan?.stakeholders || [])];
                                                  newS[i].role = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), stakeholders: newS}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} placeholder="Role" className="w-full px-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs" /></td>
                                            <td className="px-3 py-2"><span className="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">Additional</span></td>
                                            <td className="px-3 py-2 text-center">
                                              <button onClick={() => {
                                                const updated = customers.map(c => {
                                                  if (c.id === selectedCustomer.id) {
                                                    return {...c, accountPlan: {...(c.accountPlan || {}), stakeholders: (c.accountPlan?.stakeholders || []).filter((_, idx) => idx !== i)}};
                                                  }
                                                  return c;
                                                });
                                                setCustomers(updated);
                                                setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                                saveAll(updated, products, prospects);
                                              }} className="text-red-600 hover:text-red-800"><Trash2 size={14} /></button>
                                            </td>
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                  </div>
                                </details>

                                {/* Products & Whitespace */}
                                <details open className="bg-white rounded-lg shadow-md border-2 border-gray-200">
                                  <summary className="p-4 cursor-pointer font-bold text-base uppercase tracking-wide text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-300 hover:bg-gray-100">üì¶ Products & Whitespace</summary>
                                  <div className="p-6 space-y-4">
                                    <div>
                                      <h4 className="font-bold text-sm uppercase tracking-wide text-green-700 mb-3">Live Products ({Object.values(selectedCustomer.products).filter(Boolean).length})</h4>
                                      <div className="grid grid-cols-4 gap-2">
                                        {products.filter(p => selectedCustomer.products[p]).map(p => (
                                          <div key={p} className="p-2 rounded-lg border-2 bg-green-50 border-green-300 flex items-center gap-2">
                                            <Check size={16} className="text-green-700" strokeWidth={3} />
                                            <span className="text-xs font-semibold text-green-800">{p}</span>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                    <div>
                                      <h4 className="font-bold text-sm uppercase tracking-wide text-orange-700 mb-3">Whitespace ({products.filter(p => !selectedCustomer.products[p]).length})</h4>
                                      <div className="grid grid-cols-4 gap-2">
                                        {products.filter(p => !selectedCustomer.products[p]).map(p => (
                                          <div key={p} className="p-2 rounded-lg border-2 bg-gray-50 border-gray-200 flex items-center gap-2">
                                            <X size={16} className="text-gray-400" />
                                            <span className="text-xs font-semibold text-gray-500">{p}</span>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  </div>
                                </details>

                                {/* SWOT */}
                                <details open className="bg-white rounded-lg shadow-md border-2 border-gray-200">
                                  <summary className="p-4 cursor-pointer font-bold text-base uppercase tracking-wide text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-300 hover:bg-gray-100">üìä SWOT Analysis</summary>
                                  <div className="p-6 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                      {[
                                        ['strengths', 'Strengths', 'green'],
                                        ['weaknesses', 'Weaknesses', 'red'],
                                        ['opportunities', 'Opportunities', 'blue'],
                                        ['threats', 'Threats', 'orange']
                                      ].map(([key, label, color]) => (
                                        <div key={key}>
                                          <label className={`block text-xs font-bold mb-2 uppercase tracking-wide text-${color}-700`}>{label}</label>
                                          <textarea
                                            value={selectedCustomer.accountPlan?.swot?.[key] || ''}
                                            onChange={e => {
                                              const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), swot: {...(c.accountPlan?.swot || {}), [key]: e.target.value}}} : c);
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }}
                                            placeholder={`List ${label.toLowerCase()}...`}
                                            rows={5}
                                            className={`w-full px-3 py-2 bg-${color}-50 border border-${color}-300 rounded-lg text-sm focus:ring-2 focus:ring-${color}-500`}
                                          />
                                        </div>
                                      ))}
                                    </div>
                                    <div>
                                      <label className="block text-xs font-bold mb-2 uppercase text-gray-700">SWOT Summary</label>
                                      <textarea
                                        value={selectedCustomer.accountPlan?.swot?.summary || ''}
                                        onChange={e => {
                                          const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), swot: {...(c.accountPlan?.swot || {}), summary: e.target.value}}} : c);
                                          setCustomers(updated);
                                          setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                          saveAll(updated, products, prospects);
                                        }}
                                        placeholder="Overall analysis..."
                                        rows={3}
                                        className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]"
                                      />
                                    </div>
                                  </div>
                                </details>

                                {/* Account Goals */}
                                <details open className="bg-white rounded-lg shadow-md border-2 border-gray-200">
                                  <summary className="p-4 cursor-pointer font-bold text-base uppercase tracking-wide text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-300 hover:bg-gray-100">üéØ Account Goals</summary>
                                  <div className="p-6 space-y-4">
                                    <div>
                                      <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Customer Goals / Drivers</label>
                                      <input
                                        value={selectedCustomer.accountPlan?.goalsDriver || ''}
                                        onChange={e => {
                                          const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), goalsDriver: e.target.value}} : c);
                                          setCustomers(updated);
                                          setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                          saveAll(updated, products, prospects);
                                        }}
                                        placeholder="E.g., PCI compliance"
                                        className="w-full px-4 py-3 bg-purple-50 border border-purple-300 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-purple-500"
                                      />
                                    </div>

                                    <button onClick={() => {
                                      const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), goals: [...(c.accountPlan?.goals || []), {id: Date.now().toString(), what: '', how: '', targetDate: '', opportunity: ''}]}} : c);
                                      setCustomers(updated);
                                      setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                      saveAll(updated, products, prospects);
                                    }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs font-semibold uppercase">
                                      <Plus size={14} className="inline mr-1" />Add Goal
                                    </button>

                                    <table className="w-full text-sm border-2 border-gray-300 rounded-lg overflow-hidden">
                                      <thead className="bg-gradient-to-r from-gray-100 to-gray-50 border-b-2 border-gray-300">
                                        <tr>
                                          <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">What is our goal?</th>
                                          <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">How achieve it?</th>
                                          <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Target Date</th>
                                          <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Opportunity#</th>
                                          <th className="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase w-16">Del</th>
                                        </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-200">
                                        {(selectedCustomer.accountPlan?.goals || []).map((g, i) => (
                                          <tr key={g.id}>
                                            <td className="px-4 py-3"><textarea value={g.what} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newG = [...(c.accountPlan?.goals || [])];
                                                  newG[i].what = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), goals: newG}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} rows={2} className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm" /></td>
                                            <td className="px-4 py-3"><textarea value={g.how} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newG = [...(c.accountPlan?.goals || [])];
                                                  newG[i].how = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), goals: newG}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} rows={2} className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm" /></td>
                                            <td className="px-4 py-3"><input type="date" value={g.targetDate} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newG = [...(c.accountPlan?.goals || [])];
                                                  newG[i].targetDate = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), goals: newG}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm" /></td>
                                            <td className="px-4 py-3"><input value={g.opportunity} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newG = [...(c.accountPlan?.goals || [])];
                                                  newG[i].opportunity = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), goals: newG}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} placeholder="Ref" className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm" /></td>
                                            <td className="px-4 py-3 text-center">
                                              <button onClick={() => {
                                                const updated = customers.map(c => {
                                                  if (c.id === selectedCustomer.id) {
                                                    return {...c, accountPlan: {...(c.accountPlan || {}), goals: (c.accountPlan?.goals || []).filter((_, idx) => idx !== i)}};
                                                  }
                                                  return c;
                                                });
                                                setCustomers(updated);
                                                setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                                saveAll(updated, products, prospects);
                                              }} className="text-red-600 hover:text-red-800"><Trash2 size={16} /></button>
                                            </td>
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                    {!(selectedCustomer.accountPlan?.goals || []).length && <p className="text-center text-gray-500 py-6 text-sm">No goals set</p>}
                                  </div>
                                </details>

                                {/* Commercial Opportunities */}
                                <details className="bg-white rounded-lg shadow-md border-2 border-gray-200">
                                  <summary className="p-4 cursor-pointer font-bold text-base uppercase tracking-wide text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-300 hover:bg-gray-100">üí∞ Commercial Opportunities</summary>
                                  <div className="p-6">
                                    <button onClick={() => {
                                      const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), opps: [...(c.accountPlan?.opps || []), {id: Date.now().toString(), product: '', year: new Date().getFullYear().toString(), potentialARR: '', notes: '', discussedWith: '', date: ''}]}} : c);
                                      setCustomers(updated);
                                      setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                      saveAll(updated, products, prospects);
                                    }} className="mb-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs font-semibold uppercase">
                                      <Plus size={14} className="inline mr-1" />Add Opportunity
                                    </button>

                                    <table className="w-full text-sm border-2 border-gray-300 rounded-lg overflow-hidden">
                                      <thead className="bg-gradient-to-r from-gray-100 to-gray-50 border-b-2 border-gray-300">
                                        <tr>
                                          <th className="px-3 py-3 text-left text-xs font-bold uppercase">Product</th>
                                          <th className="px-3 py-3 text-left text-xs font-bold uppercase">Year</th>
                                          <th className="px-3 py-3 text-left text-xs font-bold uppercase">Pot. ARR</th>
                                          <th className="px-3 py-3 text-left text-xs font-bold uppercase">Notes</th>
                                          <th className="px-3 py-3 text-left text-xs font-bold uppercase">Discussed With</th>
                                          <th className="px-3 py-3 text-left text-xs font-bold uppercase">Date</th>
                                          <th className="px-3 py-3 text-center text-xs font-bold uppercase w-16">Del</th>
                                        </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-200">
                                        {(selectedCustomer.accountPlan?.opps || []).map((o, i) => (
                                          <tr key={o.id}>
                                            <td className="px-3 py-2">
                                              <select value={o.product} onChange={e => {
                                                const updated = customers.map(c => {
                                                  if (c.id === selectedCustomer.id) {
                                                    const newO = [...(c.accountPlan?.opps || [])];
                                                    newO[i].product = e.target.value;
                                                    return {...c, accountPlan: {...(c.accountPlan || {}), opps: newO}};
                                                  }
                                                  return c;
                                                });
                                                setCustomers(updated);
                                                setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                                saveAll(updated, products, prospects);
                                              }} className="w-full px-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs">
                                                <option value="">Select...</option>
                                                {products.map(p => <option key={p} value={p}>{p}</option>)}
                                              </select>
                                            </td>
                                            <td className="px-3 py-2"><input type="number" value={o.year} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newO = [...(c.accountPlan?.opps || [])];
                                                  newO[i].year = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), opps: newO}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} placeholder="2025" className="w-24 px-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs" /></td>
                                            <td className="px-3 py-2"><div className="relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs">¬£</span><input value={o.potentialARR} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newO = [...(c.accountPlan?.opps || [])];
                                                  newO[i].potentialARR = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), opps: newO}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} className="w-32 pl-5 pr-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs" /></div></td>
                                            <td className="px-3 py-2"><textarea value={o.notes} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newO = [...(c.accountPlan?.opps || [])];
                                                  newO[i].notes = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), opps: newO}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} rows={2} className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-xs" /></td>
                                            <td className="px-3 py-2"><input value={o.discussedWith} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newO = [...(c.accountPlan?.opps || [])];
                                                  newO[i].discussedWith = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), opps: newO}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} className="w-full px-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs" /></td>
                                            <td className="px-3 py-2"><input type="date" value={o.date} onChange={e => {
                                              const updated = customers.map(c => {
                                                if (c.id === selectedCustomer.id) {
                                                  const newO = [...(c.accountPlan?.opps || [])];
                                                  newO[i].date = e.target.value;
                                                  return {...c, accountPlan: {...(c.accountPlan || {}), opps: newO}};
                                                }
                                                return c;
                                              });
                                              setCustomers(updated);
                                              setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                              saveAll(updated, products, prospects);
                                            }} className="w-full px-2 py-1 bg-gray-50 border border-gray-200 rounded text-xs" /></td>
                                            <td className="px-3 py-2 text-center">
                                              <button onClick={() => {
                                                const updated = customers.map(c => {
                                                  if (c.id === selectedCustomer.id) {
                                                    return {...c, accountPlan: {...(c.accountPlan || {}), opps: (c.accountPlan?.opps || []).filter((_, idx) => idx !== i)}};
                                                  }
                                                  return c;
                                                });
                                                setCustomers(updated);
                                                setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                                saveAll(updated, products, prospects);
                                              }} className="text-red-600 hover:text-red-800"><Trash2 size={16} /></button>
                                            </td>
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                    {!(selectedCustomer.accountPlan?.opps || []).length && <p className="text-center text-gray-500 py-6 text-sm">No opportunities</p>}
                                  </div>
                                </details>
                              </div>

                              {/* SIDEBAR */}
                              <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">
                                <h3 className="font-bold text-base mb-4 uppercase tracking-wide text-gray-700 border-b-2 border-gray-300 pb-2">Relationship Matrix</h3>
                                <div className="space-y-4">
                                  <div>
                                    <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Strength</label>
                                    <select value={selectedCustomer.accountPlan?.relationship || ''} onChange={e => {
                                      const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), relationship: e.target.value}} : c);
                                      setCustomers(updated);
                                      setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                      saveAll(updated, products, prospects);
                                    }} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]">
                                      <option value="">Select...</option>
                                      <option value="No Relationship">No Relationship</option>
                                      <option value="Trusted Not Balanced">Trusted Not Balanced</option>
                                      <option value="Trusted Balanced">Trusted Balanced</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Potential</label>
                                    <select value={selectedCustomer.accountPlan?.potential || ''} onChange={e => {
                                      const updated = customers.map(c => c.id === selectedCustomer.id ? {...c, accountPlan: {...(c.accountPlan || {}), potential: e.target.value}} : c);
                                      setCustomers(updated);
                                      setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
                                      saveAll(updated, products, prospects);
                                    }} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#2A5C59]">
                                      <option value="">Select...</option>
                                      <option value="Low">Low ‚¨áÔ∏è</option>
                                      <option value="Med">Med ‚ÜîÔ∏è</option>
                                      <option value="High">High ‚¨ÜÔ∏è</option>
                                    </select>
                                  </div>
                                  {selectedCustomer.accountPlan?.relationship && selectedCustomer.accountPlan?.potential && (
                                    <div className={`p-4 rounded-lg border-2 ${
                                      selectedCustomer.accountPlan.potential === 'High' && selectedCustomer.accountPlan.relationship === 'Trusted Balanced' ? 'bg-green-100 border-green-400' :
                                      selectedCustomer.accountPlan.potential === 'High' ? 'bg-yellow-100 border-yellow-400' :
                                      selectedCustomer.accountPlan.relationship === 'Trusted Balanced' ? 'bg-blue-100 border-blue-400' :
                                      'bg-gray-100 border-gray-300'
                                    }`}>
                                      <p className="text-xs font-bold uppercase text-center">{selectedCustomer.accountPlan.relationship} + {selectedCustomer.accountPlan.potential}</p>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* MEETINGS TAB */}
                        {customerTab === 'meetings' && (
                          <div className="space-y-4">
                            <h3 className="font-bold text-lg">Scheduled Meetings</h3>
                            {(selectedCustomer.events || []).length > 0 ? (
                              <div className="space-y-3">
                                {selectedCustomer.events.map((ev, i) => (
                                  <div key={i} className="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                                    <div className="flex items-center gap-3 mb-2">
                                      <div className={`w-3 h-3 rounded-full ${ev.type === 'Account Review' ? 'bg-purple-600' : ev.type === 'Customer Support' ? 'bg-blue-600' : 'bg-green-600'}`}></div>
                                      <span className="font-bold text-sm uppercase">{ev.type}</span>
                                      <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${ev.meetingType === 'F2F' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}`}>{ev.meetingType}</span>
                                      <span className="text-sm font-semibold">{ev.date}</span>
                                    </div>
                                    <p className="font-bold text-sm ml-6">{ev.subject}</p>
                                    {ev.notes && <p className="text-xs text-gray-600 mt-2 ml-6">{ev.notes}</p>}
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-center text-gray-500 py-8">No meetings</p>
                            )}
                            <button onClick={() => { setSelectedCustomerForEvents(selectedCustomer); setView('events'); }} className="w-full px-4 py-3 bg-[#E5173F] text-white rounded-lg hover:bg-[#c4132f] text-sm font-semibold uppercase shadow-md">
                              <CalendarDays size={18} className="inline mr-2" />Schedule Meeting
                            </button>
                          </div>
                        )}

                        {/* PRODUCTS TAB */}
                        {customerTab === 'products' && (
                          <div>
                            <h3 className="font-bold text-base mb-4 uppercase text-gray-700 border-b-2 border-gray-300 pb-2">All Products</h3>
                            <div className="grid grid-cols-4 gap-3">
                              {products.map(p => (
                                <div key={p} className={`p-3 rounded-lg border-2 ${selectedCustomer.products[p] ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}>
                                  <div className="flex items-center gap-2">
                                    {selectedCustomer.products[p] ? <Check size={18} className="text-green-700" strokeWidth={3} /> : <X size={18} className="text-gray-400" />}
                                    <span className={`text-xs font-semibold ${selectedCustomer.products[p] ? 'text-green-800' : 'text-gray-500'}`}>{p}</span>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {/* PROSPECTS - KANBAN BOARD */}
                {view === 'prospects' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-2xl font-bold text-gray-800">Sales Pipeline</h2>
                        <p className="text-gray-600 mt-1 text-xs uppercase">{prospects.length} Prospects ‚Ä¢ ¬£{prospects.reduce((s, p) => s + (parseFloat(p.abc) || 0), 0).toLocaleString()} ABC ‚Ä¢ ¬£{prospects.reduce((s, p) => s + (parseFloat(p.margin) || 0), 0).toLocaleString()} Margin</p>
                      </div>
                      <button onClick={() => {
                        setProspectData({ name: '', industry: '', salesRep: '', abc: '', margin: '', leadSource: '', stage: 'Lead', productsOfInterest: {}, activities: [] });
                        setSelectedProspect(null);
                        setView('prospect-form');
                      }} className="px-4 py-2 bg-[#E5173F] text-white rounded-lg hover:bg-[#c4132f] text-sm font-semibold uppercase shadow-md">
                        <Plus size={16} className="inline mr-2" />New Prospect
                      </button>
                    </div>

                    <div className="grid grid-cols-5 gap-4">
                      {['Lead', 'Discovery', 'Demo', 'Proposal', 'Negotiation'].map(stage => {
                        const stageProspects = prospects.filter(p => p.stage === stage);
                        const stageValue = stageProspects.reduce((s, p) => s + (parseFloat(p.abc) || 0), 0);
                        
                        return (
                          <div key={stage} className="bg-gray-50 rounded-lg border-2 border-gray-300 p-4">
                            <div className="mb-3 pb-3 border-b-2 border-gray-300">
                              <h3 className="font-bold text-sm uppercase text-gray-700">{stage}</h3>
                              <p className="text-xs text-gray-600 mt-1">{stageProspects.length} ‚Ä¢ ¬£{Math.round(stageValue).toLocaleString()}</p>
                            </div>
                            <div className="space-y-2 max-h-[60vh] overflow-y-auto">
                              {stageProspects.map(p => (
                                <div key={p.id} className="bg-white p-3 rounded-lg border-2 border-gray-200 hover:border-[#2A5C59] hover:shadow-md transition-all">
                                  <div onClick={() => { setSelectedProspect(p); setView('prospect-detail'); }} className="cursor-pointer">
                                    <div className="flex items-center gap-2 mb-2">
                                      <div className="w-8 h-8 bg-gradient-to-br from-orange-500 to-orange-700 rounded-md flex items-center justify-center text-white font-bold text-sm">
                                        {p.name.charAt(0)}
                                      </div>
                                      <p className="font-bold text-xs text-gray-800 truncate flex-1">{p.name}</p>
                                    </div>
                                    <div className="space-y-1 text-xs">
                                      <p className="font-bold text-blue-700">ABC: ¬£{Math.round(parseFloat(p.abc) || 0).toLocaleString()}</p>
                                      <p className="font-bold text-green-700">Margin: ¬£{Math.round(parseFloat(p.margin) || 0).toLocaleString()}</p>
                                      <p className="text-gray-600 truncate">{p.salesRep}</p>
                                      <p className="text-gray-500">{(p.activities || []).length} activities</p>
                                    </div>
                                  </div>
                                  <div className="mt-2 pt-2 border-t border-gray-200 flex gap-1">
                                    {stage !== 'Lead' && (
                                      <button onClick={(e) => {
                                        e.stopPropagation();
                                        const stages = ['Lead', 'Discovery', 'Demo', 'Proposal', 'Negotiation'];
                                        const newStage = stages[stages.indexOf(stage) - 1];
                                        const updated = prospects.map(pr => pr.id === p.id ? {...pr, stage: newStage} : pr);
                                        setProspects(updated);
                                        saveAll(customers, products, updated);
                                      }} className="flex-1 px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs font-semibold hover:bg-gray-300">‚óÄ</button>
                                    )}
                                    {stage !== 'Negotiation' && (
                                      <button onClick={(e) => {
                                        e.stopPropagation();
                                        const stages = ['Lead', 'Discovery', 'Demo', 'Proposal', 'Negotiation'];
                                        const newStage = stages[stages.indexOf(stage) + 1];
                                        const updated = prospects.map(pr => pr.id === p.id ? {...pr, stage: newStage} : pr);
                                        setProspects(updated);
                                        saveAll(customers, products, updated);
                                      }} className="flex-1 px-2 py-1 bg-[#2A5C59] text-white rounded text-xs font-semibold hover:bg-[#1f4745]">‚ñ∂</button>
                                    )}
                                  </div>
                                </div>
                              ))}
                              {!stageProspects.length && <p className="text-xs text-gray-400 text-center py-4">No prospects</p>}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* PROSPECT FORM */}
                {view === 'prospect-form' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <h2 className="text-2xl font-bold text-gray-800">New Prospect</h2>
                      <button onClick={() => setView('prospects')} className="px-4 py-2 bg-gray-200 rounded-lg text-sm font-semibold uppercase">Cancel</button>
                    </div>
                    <div className="bg-white rounded-lg shadow-md border border-gray-200 p-8 space-y-6">
                      <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-semibold text-gray-700 mb-2">Prospect Name</label><input className={inputClass} placeholder="Company name" value={prospectData.name} onChange={e => setProspectData({...prospectData, name: e.target.value})} /></div>
                        <div><label className="block text-sm font-semibold text-gray-700 mb-2">Industry</label><input className={inputClass} placeholder="Industry" value={prospectData.industry} onChange={e => setProspectData({...prospectData, industry: e.target.value})} /></div>
                        <div><label className="block text-sm font-semibold text-gray-700 mb-2">Sales Rep</label><input className={inputClass} placeholder="Assigned to" value={prospectData.salesRep} onChange={e => setProspectData({...prospectData, salesRep: e.target.value})} /></div>
                        <div><label className="block text-sm font-semibold text-gray-700 mb-2">ABC (Annual Booking Contract)</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-semibold">¬£</span><input className={inputClass + " pl-8"} placeholder="0" value={prospectData.abc} onChange={e => setProspectData({...prospectData, abc: e.target.value})} /></div></div>
                        <div><label className="block text-sm font-semibold text-gray-700 mb-2">Margin</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-semibold">¬£</span><input className={inputClass + " pl-8"} placeholder="0" value={prospectData.margin} onChange={e => setProspectData({...prospectData, margin: e.target.value})} /></div></div>
                        <div><label className="block text-sm font-semibold text-gray-700 mb-2">Lead Source</label><input className={inputClass} placeholder="Referral, Website..." value={prospectData.leadSource} onChange={e => setProspectData({...prospectData, leadSource: e.target.value})} /></div>
                        <div><label className="block text-sm font-semibold text-gray-700 mb-2">Stage</label><select className={inputClass} value={prospectData.stage} onChange={e => setProspectData({...prospectData, stage: e.target.value})}>
                          {['Lead', 'Discovery', 'Demo', 'Proposal', 'Negotiation'].map(s => <option key={s} value={s}>{s}</option>)}
                        </select></div>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Products of Interest</label>
                        <div className="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-4 bg-gray-50">
                          {products.map(p => (
                            <label key={p} className="flex items-center gap-2 text-sm">
                              <input type="checkbox" checked={prospectData.productsOfInterest[p] || false} onChange={e => setProspectData({...prospectData, productsOfInterest: {...prospectData.productsOfInterest, [p]: e.target.checked}})} className="w-4 h-4" />
                              <span>{p}</span>
                            </label>
                          ))}
                        </div>
                      </div>
                      <button onClick={() => {
                        const prospect = { id: selectedProspect?.id || Date.now().toString(), ...prospectData, createdAt: selectedProspect?.createdAt || new Date().toISOString() };
                        const updated = selectedProspect ? prospects.map(p => p.id === selectedProspect.id ? prospect : p) : [...prospects, prospect];
                        setProspects(updated);
                        saveAll(customers, products, updated);
                        setView('prospects');
                      }} className="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold uppercase shadow-md">
                        <Save size={18} className="inline mr-2" />Save Prospect
                      </button>
                    </div>
                  </div>
                )}

                {/* PROSPECT DETAIL */}
                {view === 'prospect-detail' && selectedProspect && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-3xl font-bold text-gray-800">{selectedProspect.name}</h2>
                        <p className="text-gray-600 mt-1 text-xs uppercase">Stage: {selectedProspect.stage}</p>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => { setProspectData(selectedProspect); setView('prospect-form'); }} className="px-4 py-2 bg-[#2A5C59] text-white rounded-lg text-sm font-semibold uppercase shadow-md"><Edit2 size={16} className="inline mr-2" />Edit</button>
                        <button onClick={() => {
                          const newCust = {
                            id: Date.now().toString(),
                            accountInfo: { name: selectedProspect.name, id: '', industry: selectedProspect.industry, accountManager: selectedProspect.salesRep, active: true, inactiveDate: '' },
                            products: selectedProspect.productsOfInterest,
                            commercial: { arr: selectedProspect.abc, contractLength: '', renewalDate: '' },
                            contacts: [{ name: '', email: '', role: '' }],
                            events: [],
                            createdAt: new Date().toISOString()
                          };
                          setOnboardData(newCust);
                          setEditingCustomer(newCust);
                          setOnboardStep(1);
                          const updatedProspects = prospects.filter(p => p.id !== selectedProspect.id);
                          setProspects(updatedProspects);
                          saveAll(customers, products, updatedProspects);
                          setView('onboard');
                        }} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold uppercase shadow-md">Convert to Customer</button>
                        <button onClick={() => setView('prospects')} className="px-4 py-2 bg-gray-200 rounded-lg text-sm font-semibold uppercase">Back</button>
                      </div>
                    </div>

                    <div className="grid grid-cols-3 gap-6">
                      <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">
                        <h3 className="font-bold text-base mb-4 uppercase text-gray-700 border-b-2 border-gray-300 pb-2">Info</h3>
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between py-2 border-b border-gray-200"><span className="uppercase text-gray-600 font-semibold">ABC:</span><span className="font-bold text-blue-700 text-lg">¬£{Math.round(parseFloat(selectedProspect.abc) || 0).toLocaleString()}</span></div>
                          <div className="flex justify-between py-2 border-b border-gray-200"><span className="uppercase text-gray-600 font-semibold">Margin:</span><span className="font-bold text-green-700 text-lg">¬£{Math.round(parseFloat(selectedProspect.margin) || 0).toLocaleString()}</span></div>
                          <div className="flex justify-between py-2 border-b border-gray-200"><span className="uppercase text-gray-600 font-semibold">Sales Rep:</span><span className="font-semibold">{selectedProspect.salesRep}</span></div>
                          <div className="flex justify-between py-2"><span className="uppercase text-gray-600 font-semibold">Lead Source:</span><span className="font-semibold">{selectedProspect.leadSource}</span></div>
                        </div>
                      </div>

                      <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">
                        <h3 className="font-bold text-base mb-4 uppercase text-gray-700 border-b-2 border-gray-300 pb-2">Move Stage</h3>
                        {['Lead', 'Discovery', 'Demo', 'Proposal', 'Negotiation'].map(stage => (
                          <button key={stage} onClick={() => {
                            const updated = prospects.map(p => p.id === selectedProspect.id ? {...p, stage} : p);
                            setProspects(updated);
                            setSelectedProspect({...selectedProspect, stage});
                            saveAll(customers, products, updated);
                          }} className={`w-full px-4 py-2 mb-2 rounded-lg text-sm font-semibold uppercase ${selectedProspect.stage === stage ? 'bg-gradient-to-r from-[#2A5C59] to-[#E5173F] text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                            {stage}
                          </button>
                        ))}
                      </div>

                      <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">
                        <h3 className="font-bold text-base mb-4 uppercase text-gray-700 border-b-2 border-gray-300 pb-2">Products</h3>
                        <div className="flex flex-wrap gap-2">
                          {Object.entries(selectedProspect.productsOfInterest || {}).filter(([,v]) => v).map(([p]) => (
                            <span key={p} className="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">{p}</span>
                          ))}
                          {!Object.values(selectedProspect.productsOfInterest || {}).filter(Boolean).length && <p className="text-sm text-gray-500">None</p>}
                        </div>
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-6">
                      <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                        <div className="flex justify-between mb-4">
                          <h3 className="font-bold text-base uppercase text-gray-700">Log Activity</h3>
                          {!showActivityForm && <button onClick={() => setShowActivityForm(true)} className="px-4 py-2 bg-[#2A5C59] text-white rounded-lg text-sm font-semibold uppercase shadow-md"><Plus size={16} className="inline mr-2" />New</button>}
                        </div>
                        {showActivityForm ? (
                          <div className="space-y-4">
                            <div><label className="block text-xs font-bold uppercase mb-1">Type</label><select value={activityForm.type} onChange={e => setActivityForm({...activityForm, type: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm">
                              {['Initial Call', 'Demo Call', 'Scoping', 'Process Review'].map(t => <option key={t} value={t}>{t}</option>)}
                            </select></div>
                            <div><label className="block text-xs font-bold uppercase mb-1">Date</label><input type="date" value={activityForm.date} onChange={e => setActivityForm({...activityForm, date: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                            <div><label className="block text-xs font-bold uppercase mb-1">Outcome</label><input value={activityForm.outcome} onChange={e => setActivityForm({...activityForm, outcome: e.target.value})} placeholder="What was decided?" className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                            <div><label className="block text-xs font-bold uppercase mb-1">Notes</label><textarea value={activityForm.notes} onChange={e => setActivityForm({...activityForm, notes: e.target.value})} rows={3} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                            <div className="flex gap-2">
                              <button onClick={() => {
                                if (!activityForm.date || !activityForm.outcome) { alert('Fill date & outcome'); return; }
                                const updated = prospects.map(p => p.id === selectedProspect.id ? {...p, activities: [...(p.activities || []), {...activityForm, createdAt: new Date().toISOString()}]} : p);
                                setProspects(updated);
                                setSelectedProspect(updated.find(p => p.id === selectedProspect.id));
                                saveAll(customers, products, updated);
                                setActivityForm({ type: 'Initial Call', date: '', outcome: '', notes: '' });
                                setShowActivityForm(false);
                              }} className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold uppercase shadow-md">Save</button>
                              <button onClick={() => { setShowActivityForm(false); setActivityForm({ type: 'Initial Call', date: '', outcome: '', notes: '' }); }} className="px-4 py-2 bg-gray-200 rounded-lg text-sm font-semibold uppercase">Cancel</button>
                            </div>
                          </div>
                        ) : (
                          <p className="text-center text-gray-500 py-8 text-sm">Click "New"</p>
                        )}
                      </div>

                      <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                        <h3 className="font-bold text-base mb-4 uppercase text-gray-700 border-b-2 border-gray-300 pb-2">Timeline ({(selectedProspect.activities || []).length})</h3>
                        {(selectedProspect.activities || []).length > 0 ? (
                          <div className="space-y-3 max-h-96 overflow-y-auto">
                            {[...(selectedProspect.activities || [])].sort((a,b) => new Date(b.date) - new Date(a.date)).map((act, i) => (
                              <div key={i} className="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                                <div className="flex items-center gap-3 mb-2">
                                  <div className={`w-3 h-3 rounded-full ${act.type === 'Initial Call' ? 'bg-blue-600' : act.type === 'Demo Call' ? 'bg-green-600' : act.type === 'Scoping' ? 'bg-purple-600' : 'bg-orange-600'}`}></div>
                                  <span className="font-bold text-sm uppercase">{act.type}</span>
                                  <span className="text-sm font-semibold text-gray-700">{act.date}</span>
                                </div>
                                <p className="text-sm font-semibold ml-6">{act.outcome}</p>
                                {act.notes && <p className="text-xs text-gray-600 mt-2 ml-6">{act.notes}</p>}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p className="text-center text-gray-500 py-8 text-sm">No activities</p>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {/* RENEWALS PAGE */}
                {view === 'renewals' && (
                  <div className="space-y-6">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-800">Contract Renewals</h2>
                      <p className="text-gray-600 mt-1 text-xs uppercase">Upcoming Renewals</p>
                    </div>
                    <div className="grid grid-cols-3 gap-6">
                      {(() => {
                        const today = new Date();
                        const next30 = customers.filter(c => {
                          if (!c.commercial.renewalDate) return false;
                          const diff = (new Date(c.commercial.renewalDate) - today) / (1000*60*60*24);
                          return diff >= 0 && diff <= 30;
                        });
                        const next90 = customers.filter(c => {
                          if (!c.commercial.renewalDate) return false;
                          const diff = (new Date(c.commercial.renewalDate) - today) / (1000*60*60*24);
                          return diff > 30 && diff <= 90;
                        });
                        const beyond = customers.filter(c => {
                          if (!c.commercial.renewalDate) return false;
                          const diff = (new Date(c.commercial.renewalDate) - today) / (1000*60*60*24);
                          return diff > 90;
                        });

                        return [
                          ['Next 30 Days', next30, 'red'],
                          ['Next 31-90 Days', next90, 'orange'],
                          ['Beyond 90 Days', beyond.slice(0, 10), 'green']
                        ].map(([title, list, color]) => (
                          <div key={title} className={`bg-white rounded-lg shadow-md border-2 border-${color}-300 p-6`}>
                            <h3 className={`font-bold text-lg uppercase text-${color}-700 mb-1`}>{title}</h3>
                            <p className="text-3xl font-bold text-gray-800 mb-4">{list.length}</p>
                            <div className="space-y-2 max-h-96 overflow-y-auto">
                              {list.map(c => (
                                <div key={c.id} onClick={() => { setSelectedCustomer(c); setCustomerTab('overview'); setView('customer'); }} className={`p-3 bg-${color}-50 border-2 border-${color}-200 rounded-lg cursor-pointer hover:border-${color}-400 transition-all`}>
                                  <div className="flex items-center gap-2 mb-2">
                                    <div className="w-8 h-8 bg-gradient-to-br from-[#2A5C59] to-[#E5173F] rounded-md flex items-center justify-center text-white font-bold text-sm">{c.accountInfo.name.charAt(0)}</div>
                                    <div className="flex-1">
                                      <p className="font-bold text-sm truncate">{c.accountInfo.name}</p>
                                      <p className="text-xs text-gray-600">¬£{Math.round(parseFloat(c.commercial.arr) || 0).toLocaleString()}</p>
                                    </div>
                                  </div>
                                  <div className={`text-xs text-${color}-700 font-bold`}>Renews: {c.commercial.renewalDate}</div>
                                </div>
                              ))}
                              {!list.length && <p className="text-sm text-gray-500 text-center py-4">None</p>}
                            </div>
                          </div>
                        ));
                      })()}
                    </div>
                  </div>
                )}

                {/* Continue with remaining pages... */}

                {/* MEETINGS/EVENTS PAGE */}
                {view === 'events' && (
                  !selectedCustomerForEvents ? (
                    <div className="space-y-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <h2 className="text-2xl font-bold">Meetings</h2>
                          <p className="text-sm text-gray-500 mt-1">Select customer</p>
                        </div>
                      </div>
                      <div className="grid grid-cols-4 gap-3">
                        {customers.map(c => (
                          <button key={c.id} onClick={() => setSelectedCustomerForEvents(c)} className="p-3 bg-white border-2 border-gray-200 rounded-lg text-left hover:border-[#2A5C59] hover:shadow-md transition-all">
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 bg-gradient-to-br from-[#2A5C59] to-[#E5173F] rounded-md flex items-center justify-center text-white font-bold text-sm">{c.accountInfo.name.charAt(0)}</div>
                              <div>
                                <p className="text-sm font-semibold">{c.accountInfo.name}</p>
                                <p className="text-xs text-gray-500">{c.accountInfo.id}</p>
                              </div>
                            </div>
                          </button>
                        ))}
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-6">
                      <div className="flex justify-between">
                        <div>
                          <h2 className="text-2xl font-bold">{selectedCustomerForEvents.accountInfo.name}</h2>
                          <p className="text-xs uppercase text-gray-600">Meeting Management</p>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => setSelectedCustomerForEvents(null)} className="px-4 py-2 bg-gray-200 rounded-lg text-sm font-semibold">Change Customer</button>
                          <button onClick={() => setView('summary')} className="px-4 py-2 bg-gray-200 rounded-lg text-sm font-semibold">Back</button>
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-6">
                        <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                          <div className="flex justify-between mb-4">
                            <h3 className="font-bold text-base uppercase text-gray-700">{editingEventIdx !== null ? 'Edit' : 'Schedule'} Meeting</h3>
                            {!showEventForm && <button onClick={() => setShowEventForm(true)} className="px-4 py-2 bg-[#2A5C59] text-white rounded-lg text-sm font-semibold uppercase shadow-md"><Plus size={16} className="inline mr-2" />New</button>}
                          </div>
                          {showEventForm ? (
                            <div className="space-y-4">
                              <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-bold uppercase mb-1">Type</label><select value={eventForm.type} onChange={e => setEventForm({...eventForm, type: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm">
                                  {['Account Review', 'Customer Support', 'Demo'].map(t => <option key={t} value={t}>{t}</option>)}
                                </select></div>
                                <div><label className="block text-xs font-bold uppercase mb-1">Format</label><select value={eventForm.meetingType} onChange={e => setEventForm({...eventForm, meetingType: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm">
                                  {['F2F', 'Telephone'].map(t => <option key={t} value={t}>{t}</option>)}
                                </select></div>
                              </div>
                              <div><label className="block text-xs font-bold uppercase mb-1">Date</label><input type="date" value={eventForm.date} onChange={e => setEventForm({...eventForm, date: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                              <div><label className="block text-xs font-bold uppercase mb-1">Subject</label><input value={eventForm.subject} onChange={e => setEventForm({...eventForm, subject: e.target.value})} placeholder="Meeting subject" className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                              <div><label className="block text-xs font-bold uppercase mb-1">Internal Attendees</label><input value={eventForm.internalAttendees} onChange={e => setEventForm({...eventForm, internalAttendees: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                              <div><label className="block text-xs font-bold uppercase mb-1">External Attendees</label><input value={eventForm.externalAttendees} onChange={e => setEventForm({...eventForm, externalAttendees: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                              <div><label className="block text-xs font-bold uppercase mb-1">Notes</label><textarea value={eventForm.notes} onChange={e => setEventForm({...eventForm, notes: e.target.value})} rows={4} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" /></div>
                              <div className="flex gap-2">
                                <button onClick={() => {
                                  if (!eventForm.date || !eventForm.subject) { alert('Fill date & subject'); return; }
                                  const updated = customers.map(c => {
                                    if (c.id === selectedCustomerForEvents.id) {
                                      const evs = [...(c.events || [])];
                                      if (editingEventIdx !== null) evs[editingEventIdx] = eventForm;
                                      else evs.push(eventForm);
                                      return {...c, events: evs};
                                    }
                                    return c;
                                  });
                                  setCustomers(updated);
                                  setSelectedCustomerForEvents(updated.find(c => c.id === selectedCustomerForEvents.id));
                                  saveAll(updated, products, prospects);
                                  setEventForm({ type: 'Account Review', meetingType: 'F2F', date: '', subject: '', notes: '', internalAttendees: '', externalAttendees: '' });
                                  setShowEventForm(false);
                                  setEditingEventIdx(null);
                                }} className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold uppercase shadow-md">{editingEventIdx !== null ? 'Update' : 'Save'}</button>
                                <button onClick={() => { setShowEventForm(false); setEditingEventIdx(null); setEventForm({ type: 'Account Review', meetingType: 'F2F', date: '', subject: '', notes: '', internalAttendees: '', externalAttendees: '' }); }} className="px-4 py-2 bg-gray-200 rounded-lg text-sm font-semibold uppercase">Cancel</button>
                              </div>
                            </div>
                          ) : (
                            <p className="text-center text-gray-500 py-8 text-sm">Click "New"</p>
                          )}
                        </div>

                        <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                          <h3 className="font-bold text-base mb-4 uppercase text-gray-700">Scheduled ({(selectedCustomerForEvents.events || []).length})</h3>
                          {(selectedCustomerForEvents.events || []).length > 0 ? (
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                              {selectedCustomerForEvents.events.map((ev, i) => (
                                <div key={i} className="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                                  <div className="flex justify-between">
                                    <div className="flex-1">
                                      <div className="flex items-center gap-3 mb-2">
                                        <div className={`w-3 h-3 rounded-full ${ev.type === 'Account Review' ? 'bg-purple-600' : ev.type === 'Customer Support' ? 'bg-blue-600' : 'bg-green-600'}`}></div>
                                        <span className="font-bold text-sm uppercase">{ev.type}</span>
                                        <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${ev.meetingType === 'F2F' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}`}>{ev.meetingType}</span>
                                        <span className="text-sm font-semibold">{ev.date}</span>
                                      </div>
                                      <p className="font-bold text-sm ml-6 mb-2">{ev.subject}</p>
                                      {ev.internalAttendees && <p className="text-xs ml-6"><span className="font-bold uppercase">Int:</span> {ev.internalAttendees}</p>}
                                      {ev.externalAttendees && <p className="text-xs ml-6"><span className="font-bold uppercase">Ext:</span> {ev.externalAttendees}</p>}
                                      {ev.notes && <p className="text-xs text-gray-600 mt-2 ml-6 border-t pt-2">{ev.notes}</p>}
                                    </div>
                                    <div className="flex gap-1">
                                      <button onClick={() => { setEventForm(ev); setEditingEventIdx(i); setShowEventForm(true); }} className="p-2 text-[#2A5C59] hover:bg-teal-50 rounded"><Edit2 size={16} /></button>
                                      <button onClick={() => {
                                        const updated = customers.map(c => c.id === selectedCustomerForEvents.id ? {...c, events: c.events.filter((_, idx) => idx !== i)} : c);
                                        setCustomers(updated);
                                        setSelectedCustomerForEvents(updated.find(c => c.id === selectedCustomerForEvents.id));
                                        saveAll(updated, products, prospects);
                                      }} className="p-2 text-red-600 hover:bg-red-50 rounded"><Trash2 size={16} /></button>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          ) : (
                            <p className="text-center text-gray-500 py-8 text-sm uppercase">No meetings</p>
                          )}
                        </div>
                      </div>
                    </div>
                  )
                )}

                {/* TIMELINE */}
                {view === 'timeline' && (
                  <div className="space-y-6">
                    <div>
                      <h2 className="text-2xl font-bold">Timeline</h2>
                      <p className="text-xs uppercase text-gray-600">12-Month View</p>
                    </div>
                    <div className="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                      <div className="overflow-x-auto" style={{maxHeight: '70vh'}}>
                        <table className="w-full">
                          <thead className="bg-gradient-to-r from-gray-100 to-gray-50 sticky top-0 border-b-2 border-gray-300">
                            <tr>
                              <th className="px-6 py-4 text-left text-xs font-bold uppercase sticky left-0 bg-gradient-to-r from-gray-100 to-gray-50 z-10 border-r-2 border-gray-300">Customer</th>
                              {Array.from({length: 12}, (_, i) => {
                                const d = new Date();
                                d.setMonth(d.getMonth() + i);
                                return { key: d.toISOString().slice(0, 7), label: d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) };
                              }).map(m => (
                                <th key={m.key} className="px-4 py-4 text-center text-xs font-bold uppercase border-l border-gray-200" style={{minWidth: '140px'}}>{m.label}</th>
                              ))}
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {customers.map((c, idx) => (
                              <tr key={c.id} className={`hover:bg-blue-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                <td className="px-6 py-4 font-semibold sticky left-0 bg-inherit z-10 border-r-2 border-gray-300">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 min-w-[40px] min-h-[40px] bg-gradient-to-br from-[#2A5C59] to-[#E5173F] rounded-lg flex items-center justify-center text-white font-bold shadow-sm flex-shrink-0">{c.accountInfo.name.charAt(0)}</div>
                                    <span>{c.accountInfo.name}</span>
                                  </div>
                                </td>
                                {Array.from({length: 12}, (_, i) => {
                                  const d = new Date();
                                  d.setMonth(d.getMonth() + i);
                                  const monthKey = d.toISOString().slice(0, 7);
                                  const evs = (c.events || []).filter(e => e.date && e.date.startsWith(monthKey));
                                  return (
                                    <td key={monthKey} className="px-4 py-4 border-l border-gray-200">
                                      <div className="space-y-2">
                                        {evs.map((e, i) => (
                                          <div key={i} className={`px-3 py-2 rounded-lg text-xs font-bold shadow-sm border-2 ${e.type === 'Account Review' ? 'bg-purple-100 text-purple-800 border-purple-300' : e.type === 'Customer Support' ? 'bg-blue-100 text-blue-800 border-blue-300' : 'bg-green-100 text-green-800 border-green-300'}`}>
                                            <div className="uppercase">{e.type}</div>
                                            <div className="text-[11px] opacity-90 mt-1">{e.meetingType} ‚Ä¢ Day {e.date.slice(8)}</div>
                                            {e.subject && <div className="text-[11px] mt-1">{e.subject}</div>}
                                          </div>
                                        ))}
                                      </div>
                                    </td>
                                  );
                                })}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {/* ONBOARDING */}
                {view === 'onboard' && (
                  <div className="space-y-6">
                    <div className="flex items-center justify-between mb-8">
                      <div className="flex items-center gap-4">
                        {[1,2,3,4,5].map(s => (
                          <React.Fragment key={s}>
                            <div className="flex flex-col items-center">
                              <div className={`w-12 h-12 rounded-lg flex items-center justify-center font-bold text-lg ${s === onboardStep ? 'bg-blue-600 text-white shadow-lg' : s < onboardStep ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                {s < onboardStep ? <Check size={20} /> : s}
                              </div>
                              <span className={`text-xs mt-2 font-semibold ${s === onboardStep ? 'text-blue-600' : 'text-gray-500'}`}>{['Account', 'Products', 'Commercial', 'Contacts', 'Review'][s-1]}</span>
                            </div>
                            {s < 5 && <div className={`h-1 w-12 rounded ${s < onboardStep ? 'bg-green-600' : 'bg-gray-200'}`}></div>}
                          </React.Fragment>
                        ))}
                      </div>
                      <button onClick={() => setView('summary')} className="px-5 py-2.5 bg-gray-200 rounded-lg font-semibold">Cancel</button>
                    </div>

                    <div className="bg-white rounded-lg p-8 border border-gray-200">
                      {onboardStep === 1 && (
                        <div className="space-y-6">
                          <div><label className="block text-sm font-semibold mb-2">Customer Name</label><input className={inputClass} placeholder="Name" value={onboardData.accountInfo.name} onChange={e => setOnboardData({...onboardData, accountInfo: {...onboardData.accountInfo, name: e.target.value}})} /></div>
                          <div><label className="block text-sm font-semibold mb-2">Customer ID</label><input className={inputClass} placeholder="ID" value={onboardData.accountInfo.id} onChange={e => setOnboardData({...onboardData, accountInfo: {...onboardData.accountInfo, id: e.target.value}})} /></div>
                          <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-sm font-semibold mb-2">Industry</label><input className={inputClass} placeholder="Industry" value={onboardData.accountInfo.industry} onChange={e => setOnboardData({...onboardData, accountInfo: {...onboardData.accountInfo, industry: e.target.value}})} /></div>
                            <div><label className="block text-sm font-semibold mb-2">Account Manager</label><input className={inputClass} placeholder="Manager" value={onboardData.accountInfo.accountManager} onChange={e => setOnboardData({...onboardData, accountInfo: {...onboardData.accountInfo, accountManager: e.target.value}})} /></div>
                          </div>
                          <label className="inline-flex items-center gap-2 text-sm font-semibold">
                            <input type="checkbox" checked={onboardData.accountInfo.active} onChange={e => setOnboardData({...onboardData, accountInfo: {...onboardData.accountInfo, active: e.target.checked, inactiveDate: e.target.checked ? '' : onboardData.accountInfo.inactiveDate}})} className="w-4 h-4" />
                            Active account
                          </label>
                          {!onboardData.accountInfo.active && (
                            <div><label className="block text-sm font-semibold mb-2">Inactive from</label><input type="date" className={inputClass} value={onboardData.accountInfo.inactiveDate} onChange={e => setOnboardData({...onboardData, accountInfo: {...onboardData.accountInfo, inactiveDate: e.target.value}})} /></div>
                          )}
                        </div>
                      )}
                      {onboardStep === 2 && (
                        <div className="space-y-6">
                          <div className="flex justify-between">
                            <h3 className="text-lg font-semibold">Select Products</h3>
                            <button onClick={() => setShowProductMgr(!showProductMgr)} className="px-4 py-2 bg-purple-600 text-white rounded-lg"><LayoutGrid size={16} className="inline mr-2" />Manage</button>
                          </div>
                          {showProductMgr && (
                            <div className="p-6 bg-purple-50 rounded-lg border border-purple-200">
                              <div className="flex gap-2 mb-4">
                                <input className="flex-1 px-4 py-3 border rounded-lg" placeholder="New product" value={newProduct} onChange={e => setNewProduct(e.target.value)} onKeyPress={e => e.key === 'Enter' && (() => {
                                  if (newProduct && !products.includes(newProduct)) {
                                    const updated = [...products, newProduct];
                                    setProducts(updated);
                                    saveAll(customers, updated, prospects);
                                    setNewProduct('');
                                  }
                                })()} />
                                <button onClick={() => {
                                  if (newProduct && !products.includes(newProduct)) {
                                    const updated = [...products, newProduct];
                                    setProducts(updated);
                                    saveAll(customers, updated, prospects);
                                    setNewProduct('');
                                  }
                                }} className="px-5 py-3 bg-green-600 text-white rounded-lg"><Plus size={20} /></button>
                              </div>
                              <div className="space-y-2 max-h-60 overflow-y-auto">
                                {products.map(p => (
                                  <div key={p} className="flex justify-between p-3 bg-white rounded-lg shadow-sm">
                                    <span className="text-sm font-medium">{p}</span>
                                    <button onClick={() => {
                                      const updated = products.filter(x => x !== p);
                                      setProducts(updated);
                                      const updatedCusts = customers.map(c => ({...c, products: Object.fromEntries(Object.entries(c.products).filter(([k]) => k !== p))}));
                                      setCustomers(updatedCusts);
                                      saveAll(updatedCusts, updated, prospects);
                                    }} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16} /></button>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          <div className="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto">
                            {products.map(p => (
                              <label key={p} className="flex items-center gap-3 p-4 bg-gray-50 border rounded-lg hover:bg-blue-50 hover:border-blue-300 cursor-pointer">
                                <input type="checkbox" checked={onboardData.products[p] || false} onChange={e => setOnboardData({...onboardData, products: {...onboardData.products, [p]: e.target.checked}})} className="w-5 h-5" />
                                <span className="text-sm font-medium">{p}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                      )}
                      {onboardStep === 3 && (
                        <div className="space-y-6">
                          <div><label className="block text-sm font-semibold mb-2">ARR</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 font-semibold">¬£</span><input className={inputClass + " pl-8"} placeholder="0" value={onboardData.commercial.arr} onChange={e => setOnboardData({...onboardData, commercial: {...onboardData.commercial, arr: e.target.value}})} /></div></div>
                          <div><label className="block text-sm font-semibold mb-2">Contract Length (Years)</label><select className={inputClass} value={onboardData.commercial.contractLength} onChange={e => setOnboardData({...onboardData, commercial: {...onboardData.commercial, contractLength: e.target.value}})}>
                            <option value="">Select</option>
                            {[1,2,3,4,5].map(y => <option key={y} value={y}>{y} Year{y > 1 ? 's' : ''}</option>)}
                          </select></div>
                          <div><label className="block text-sm font-semibold mb-2">Renewal Date</label><input type="date" className={inputClass} value={onboardData.commercial.renewalDate} onChange={e => setOnboardData({...onboardData, commercial: {...onboardData.commercial, renewalDate: e.target.value}})} /></div>
                        </div>
                      )}
                      {onboardStep === 4 && (
                        <div className="space-y-6">
                          <div className="flex justify-between">
                            <h3 className="text-lg font-semibold">Contacts</h3>
                            <button onClick={() => setOnboardData({...onboardData, contacts: [...onboardData.contacts, {name: '', email: '', role: ''}]})} className="px-4 py-2 bg-blue-600 text-white rounded-lg"><Plus size={16} className="inline mr-2" />Add</button>
                          </div>
                          <div className="space-y-4 max-h-96 overflow-y-auto">
                            {onboardData.contacts.map((c, i) => (
                              <div key={i} className="p-6 bg-gray-50 rounded-lg border space-y-4">
                                <div className="flex justify-between"><h4 className="font-semibold">Contact {i + 1}</h4>{onboardData.contacts.length > 1 && <button onClick={() => setOnboardData({...onboardData, contacts: onboardData.contacts.filter((_, idx) => idx !== i)})} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16} /></button>}</div>
                                <input className={inputClass} placeholder="Name" value={c.name} onChange={e => { const updated = [...onboardData.contacts]; updated[i].name = e.target.value; setOnboardData({...onboardData, contacts: updated}); }} />
                                <input className={inputClass} placeholder="Email" type="email" value={c.email} onChange={e => { const updated = [...onboardData.contacts]; updated[i].email = e.target.value; setOnboardData({...onboardData, contacts: updated}); }} />
                                <input className={inputClass} placeholder="Role" value={c.role} onChange={e => { const updated = [...onboardData.contacts]; updated[i].role = e.target.value; setOnboardData({...onboardData, contacts: updated}); }} />
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {onboardStep === 5 && (
                        <div className="space-y-6">
                          <div className="grid grid-cols-2 gap-6">
                            <div className="p-6 bg-blue-50 rounded-lg border border-blue-200">
                              <h3 className="font-semibold mb-4">Account Info</h3>
                              <div className="space-y-2 text-sm">
                                <div className="flex justify-between"><span className="text-gray-600">Name:</span><span className="font-semibold">{onboardData.accountInfo.name}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">ID:</span><span className="font-semibold">{onboardData.accountInfo.id}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">Industry:</span><span className="font-semibold">{onboardData.accountInfo.industry}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">Manager:</span><span className="font-semibold">{onboardData.accountInfo.accountManager}</span></div>
                              </div>
                            </div>
                            <div className="p-6 bg-green-50 rounded-lg border border-green-200">
                              <h3 className="font-semibold mb-4">Commercial</h3>
                              <div className="space-y-2 text-sm">
                                <div className="flex justify-between"><span className="text-gray-600">ARR:</span><span className="font-semibold">¬£{onboardData.commercial.arr}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">Contract:</span><span className="font-semibold">{onboardData.commercial.contractLength} Year(s)</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">Renewal:</span><span className="font-semibold">{onboardData.commercial.renewalDate}</span></div>
                              </div>
                            </div>
                          </div>
                          <div className="p-6 bg-purple-50 rounded-lg border border-purple-200">
                            <h3 className="font-semibold mb-3">Products ({Object.values(onboardData.products).filter(Boolean).length})</h3>
                            <div className="flex flex-wrap gap-2">
                              {Object.entries(onboardData.products).filter(([,v]) => v).map(([p]) => (
                                <span key={p} className="px-3 py-1.5 bg-white text-purple-700 rounded-lg text-xs font-medium border border-purple-200">{p}</span>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="flex justify-between">
                      <button onClick={() => setOnboardStep(Math.max(1, onboardStep - 1))} disabled={onboardStep === 1} className="px-8 py-3 bg-gray-200 rounded-lg font-semibold disabled:opacity-50">Previous</button>
                      {onboardStep < 5 ? (
                        <button onClick={() => setOnboardStep(onboardStep + 1)} className="px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold">Next</button>
                      ) : (
                        <button onClick={() => {
                          const customer = { id: editingCustomer?.id || Date.now().toString(), ...onboardData, events: editingCustomer?.events || [], createdAt: editingCustomer?.createdAt || new Date().toISOString() };
                          const updated = editingCustomer ? customers.map(c => c.id === editingCustomer.id ? customer : c) : [...customers, customer];
                          setCustomers(updated);
                          saveAll(updated, products, prospects);
                          setView('summary');
                        }} className="px-8 py-3 bg-green-600 text-white rounded-lg font-semibold">
                          <Save size={18} className="inline mr-2" />{editingCustomer ? 'Update' : 'Save'}
                        </button>
                      )}
                    </div>
                  </div>
                )}

              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
